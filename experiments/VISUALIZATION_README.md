# V-GPS Action Visualization

This directory contains scripts to visualize the action proposals generated by V-GPS during evaluation.

## Overview

V-GPS samples multiple actions (e.g., 50) at each timestep and selects the one with the highest Q-value. These visualization scripts help you understand:
- Where each proposed action would move the robot's end-effector
- What Q-value each action receives from the critic
- Which action was ultimately chosen
- The distribution of gripper states (open/closed) across proposals

**NEW: Frame Overlay Visualization!** The script now projects action proposals directly onto the camera frames, showing exactly where each proposed action would move the end-effector in the robot's view. This uses 3D-to-2D projection with camera intrinsics/extrinsics and depth-based occlusion checking.

## Files

- `visualize_vgps_actions.py` - Main Python script for generating visualizations
- `scripts/visualize_vgps.sh` - Shell script to run the visualization

## Usage

### Basic Usage

```bash
cd /home/electroshk/Documents/research/V-GPS
bash experiments/scripts/visualize_vgps.sh
```

### Customizing Parameters

Edit `scripts/visualize_vgps.sh` or run the Python script directly:

```bash
python experiments/visualize_vgps_actions.py \
  --seed=0 \
  --model_name=octo-small \
  --task_name=widowx_put_eggplant_in_basket \
  --vgps_checkpoint="checkpoints/checkpoint_500000" \
  --num_samples=50 \
  --action_temp=1.0 \
  --num_eval_episodes=1 \
  --max_timesteps=20 \
  --show_gripper=True \
  --show_rotation=False
```

### Parameters

- `--seed`: Random seed (default: 0)
- `--model_name`: Octo model variant (default: octo-small)
- `--task_name`: Task to visualize (e.g., widowx_put_eggplant_in_basket)
- `--vgps_checkpoint`: Path to V-GPS checkpoint
- `--num_samples`: Number of action samples per timestep (default: 50)
- `--action_temp`: Temperature for action selection (default: 1.0)
  - Set to 0 for deterministic (argmax) selection
  - Higher values = more stochastic selection
- `--num_eval_episodes`: Number of episodes to visualize (default: 1)
- `--max_timesteps`: Maximum timesteps to visualize per episode (default: 20)
- `--show_gripper`: Color-code actions by gripper state (default: True)
- `--show_rotation`: Show rotation arrows (default: False, not yet implemented)

## Output

The script creates visualizations in `logs/visualizations/{model_name}_VGPS/seed_{seed}/{task_name}/episode_{i}/`

For each timestep, you'll get:
1. **3D scatter plot**: Shows all proposed end-effector positions in 3D space
   - Blue dot = current end-effector position
   - Colored dots = proposed positions (color = Q-value)
   - Red star = chosen action
   - Red arrow = direction of chosen action

2. **XY projection**: Top-down view of the workspace
   - If `show_gripper=True`: Green = open gripper, Purple = closed gripper
   - Otherwise: Color-coded by Q-value
   - Transparency indicates Q-value (more opaque = higher Q)

3. **Q-value distribution**: Bar chart showing all Q-values
   - Actions sorted by Q-value
   - Red bar = chosen action
   - Statistics box shows min/max/mean/chosen Q-value and rank

## Example Output Structure

```
logs/visualizations/octo-small_VGPS/
└── seed_0/
    └── widowx_put_eggplant_in_basket/
        ├── episode_0/
        │   ├── timestep_000.png
        │   ├── timestep_001.png
        │   ├── ...
        │   └── episode_0_successTrue.mp4
        └── summary.txt
```

## Understanding the Visualizations

### 3D Scatter Plot
- **Current EE (blue)**: Where the robot's end-effector currently is
- **Proposed positions (colored dots)**: Where each of the 50 sampled actions would move the EE
- **Color gradient**: Red (low Q) → Yellow → Green (high Q)
- **Red star**: The action that was actually chosen and executed
- **Red arrow**: Direction and magnitude of the chosen action

### XY Projection
- **With gripper visualization**: 
  - Green dots = actions that would open the gripper
  - Purple dots = actions that would close the gripper
  - Opacity = Q-value (more visible = higher Q)
- **Without gripper**: Simple Q-value color coding

### Q-value Distribution
- Shows all 50 Q-values sorted from lowest to highest
- Red bar indicates which action was chosen
- Text box shows:
  - Max/Min/Mean Q-values across all samples
  - Q-value of the chosen action
  - Rank of chosen action (e.g., 45/50 means 5th highest)

## Action Space Details

The visualization shows **delta actions** in the end-effector space:
- **Position (xyz)**: Translation deltas from current position
- **Rotation**: Euler angle deltas (not visualized by default)
- **Gripper**: Binary open (>0.5) or close (<0.5)

The robot uses these delta commands to move its end-effector relative to its current pose.

## Troubleshooting

1. **ImportError**: Make sure you've installed all dependencies from `requirements.txt`
2. **CUDA errors**: The script sets `XLA_PYTHON_CLIENT_PREALLOCATE=false` to avoid memory issues
3. **Checkpoint not found**: Verify the path to your V-GPS checkpoint
4. **No visualizations generated**: Check that `use_vgps=True` in the model initialization

## Notes

- The visualization only works when V-GPS is enabled (`use_vgps=True`)
- Generating visualizations is slower than normal evaluation due to plotting overhead
- Each timestep generates one PNG file, so limit `max_timesteps` for faster iteration
- The script also saves a video of the episode for reference
